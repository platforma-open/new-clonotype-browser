pt := import("@platforma-sdk/workflow-tengo:pt")
wf := import("@platforma-sdk/workflow-tengo:workflow")
assets := import("@platforma-sdk/workflow-tengo:assets")
render := import("@platforma-sdk/workflow-tengo:render")
util := import(":util")
pFrames := import("@platforma-sdk/workflow-tengo:pframes")

doCalculations := assets.importTemplate(":do-calculations")
exportTable := assets.importTemplate(":export-table")

wf.setPreRun(assets.importTemplate(":prerun"))

wf.body(func(args) {
	if is_undefined(args.inputAnchor) {
		return {
			outputs: {},
			exports: {}
		}
	}

	blockId := wf.getBlockId()

	exports := {}
	outputs := {}

	if len(args.annotationSpecs.specs) > 0 {
		columnBundle := util.createColumnBundle(wf, args)
		calculationResult := render.createEphemeral(doCalculations, {
			blockId: blockId,
			blockArgs: args,
			columnBundle: columnBundle,
			shoudlComputeFilters: true
		})

		outputs["annotationPf"] = calculationResult.output("annotationPf")
		outputs["annotationStatsPf"] = calculationResult.output("annotationStatsPf")
		outputs["sampleStatsPf"] = calculationResult.output("sampleStatsPf")

		exports["annotationPf"] = calculationResult.output("annotationPf")
		exports["filtersPf"] = calculationResult.output("filtersPf")
	}

	return {
		outputs: outputs,
		exports: exports
	}
})

